<!DOCTYPE html>
<html>
  <head>
    <title>Call Simulation</title>
  </head>
  <body>
    <div>
        <textarea rows="10" cols="60" id="current"></textarea>
    </div>
    <div>
    <input type="button" onclick="calculateScore();" value="Calculate!" />
    <input type="button" onclick="printHeroes();" value="Check Heroes" />
    <input type="button" onclick="printAlliances();" value="Check Alliances" />
    </div>
    <p id="text" />
    <script type="text/javascript">
const txt = `
anti-mage,1,elusive,demon hunter
axe,1,brawny,warrior
batrider,1,troll,knight
bloodseeker,1,human,assassin
bounty hunter,1,scrappy,assassin
clockwerk,1,scrappy,inventor
drow ranger,1,heartless,hunter
enchantress,1,savage,druid
ogre magi,1,blood-bound,mage
shadow shaman,1,troll,shaman
tinker,1,scrappy,inventor
tiny,1,primordial,warrior
tusk,1,savage,warrior
warlock,1,blood-bound,warlock
beastmaster,2,brawny,hunter
chaos knight,2,demon,knight
crystal maiden,2,human,mage
juggernaut,2,brawny,warrior
luna,2,elusive,knight
morphling,2,primordial,assassin
nature's prophet,2,elusive,druid
puck,2,elusive,dragon,mage
pudge,2,heartless,warrior
queen of pain,2,demon,assassin
slardar,2,scaled,warrior
timbersaw,2,scrappy,inventor
treant protector,2,elusive,druid
witch doctor,2,troll,warlock
abaddon,3,heartless,knight
arc warden,3,primordial,shaman
lina,3,human,mage
lycan,3,human,savage,warrior
omniknight,3,human,knight
phantom assassin,3,elusive,assassin
razor,3,primordial,mage
sand king,3,savage,assassin
shadow fiend,3,demon,warlock
slark,3,scaled,assassin
sniper,3,deadeye,hunter
terrorblade,3,demon,demon hunter
venomancer,3,savage,warlock
viper,3,dragon,assassin
windranger,3,elusive,hunter
alchemist,4,scrappy,warlock
disruptor,4,brawny,shaman
doom,4,demon,warrior
dragon knight,4,human,dragon,knight
keeper of the light,4,human,mage
kunkka,4,human,warrior
lone druid,4,savage,druid
medusa,4,scaled,hunter
mirana,4,elusive,hunter
necrophos,4,heartless,warlock
templar assassin,4,elusive,assassin
troll warlord,4,troll,warrior
enigma,5,primordial,warlock
gyrocopter,5,deadeye,inventor
lich,5,heartless,mage
techies,5,scrappy,inventor
tidehunter,5,scaled,hunter`;

let heroes = [];
let heroesByAlliances = {};
let alliances = [];

function setup() {
  const lines = txt.split('\n').filter(s => s).map(s => s.split(','));
  heroes = lines.map(line => {
    const name = line[0];
    const alliances = line.slice(2);
    return { name, alliances, tier: parseInt(line[1], 10) };
  });

  heroes.forEach(hero => {
    console.log('hero', hero);
    hero.alliances.forEach(alliance => {
      heroesByAlliances[alliance] = heroesByAlliances[alliance] || [];
      heroesByAlliances[alliance].push(hero.name);
    });
  });

  console.log('by alliances', heroesByAlliances);
  alliances = Object.keys(heroesByAlliances);
  alliances.sort();

  alliances.forEach(alliance => {
    heroesByAlliances[alliance].sort();
  });
}

function printToScreen(s) {
  document.getElementById('text').innerHTML = s;
}

function printHeroes() {
  const heroNames = heroes.map(hero => hero.name).join('\n');
  printToScreen(heroNames);
}

function printAlliances() {
  const printed = alliances.map(alliance => {
    return `${alliance}: ${heroesByAlliances[alliance].join(', ')}`;
  });
  printToScreen(printed.join('<br/><br/>'));
}

const allianceLimits = {
  assassin: [3,6,9],
  ['blood-bound']: [2],
  brawny: [2,4],
  deadeye: [2],
  demon: [1],
  ['demon hunter']: [1,2],
  dragon: [3],
  druid: [2,4],
  elusive: [3,6,9],
  heartless: [2,4,6],
  human: [2,4,6],
  hunter: [3,6],
  inventor: [2,4],
  knight: [2,4,6],
  mage: [3,6],
  primordial: [2,4],
  savage: [2,4,6],
  scaled: [2,4],
  scrappy: [3,6],
  shaman: [2],
  troll: [2,4],
  warlock: [2,4,6],
  warrior: [3,6,9],
};

function alliancesCount(selectedHeroes) {
  const counts = {};
  selectedHeroes.forEach(hero => {
    hero.alliances.forEach(alliance => {
      counts[alliance] = counts[alliance] || 0;
      counts[alliance]++;
    });
  });

  return counts;
}

function currentScores(selectedHeroes) {
  const counts = alliancesCount(selectedHeroes);
  return alliances.map(alliance => {
    const count = counts[alliance] || 0;
    const limitPassed = allianceLimits[alliance].filter(x => x <= count);

    return {
      alliance, count,
      score: limitPassed.length > 0 ? limitPassed[limitPassed.length-1] : 0,
    };
  });
}

function getHeroes(names) {
  return names.map(s => s.split(',')).map([name, star] => {
    const h = heroes.find(hero => hero.name.toLowerCase() === name.toLowerCase());
    return {...h, star: star ? parseInt(star, 10) : 0};
  });
}

function getText(name) {
  return document.getElementById(name).value;
}

function getCurrentNames() {
  return getText('current').split('\n').map(s => s.trim()).filter(s => s);
}

function sortScore(firstScore, secondScore) {
  if (firstScore.score !== secondScore.score) return secondScore.score - firstScore.score;
  if (firstScore.count !== secondScore.count) return secondScore.count !== firstScore.count;
  return firstScore.alliance < secondScore.alliance ? -1 : 1;
}

function printScore(scores) {
  printToScreen(scores.filter(score => score.score > 0).sort(sortScore).map(score => `${score.alliance} ${score.score} ${score.count}`).join('<br/>'));
}

function calculateScore() {
  const names = getCurrentNames();
  const selectedHeroes = getHeroes(names);
  const scores = currentScores(selectedHeroes);
  printScore(scores);
}

function sortHeroByStar(first, second) {
  if (first.star !== second.star) return second.star - first.star;
  if (first.tier !== second.tier) return second.tier-first.tier;
  return first.name < second.name ? -1 : 1;
}

function getRank(selectedHeroes) {
  const stars = [...selectedHeroes];
  stars.sort(sortHeroByStar);
  return stars;
}

function possibleScores(selectedHeroes) {
  const scores = const counts = alliancesCount(selectedHeroes);
  return alliances.map(alliance => {
    const count = counts[alliance] || 0;
    const limitPassed = allianceLimits[alliance].filter(x => x <= count + 10 - selectedHeroes.length);

    return {
      alliance, count,
      score: limitPassed.length > 0 ? limitPassed[limitPassed.length-1] : 0,
    };
  });
}

function fullScore(selectedHeroes) {
  return {
    heroes: getRank(selectedHeroes),
    currentScore: currentScores(selectedHeroes),
    potential: possibleScores(selectedHeroes),
  };
}

setup();
    </script>
  </body>
</html>
